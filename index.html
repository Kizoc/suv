<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>多订阅统一上传工具</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; padding: 20px; background: #f9f9f9;}
  textarea, input[type=text] { width: 100%; padding: 8px; margin: 8px 0; box-sizing: border-box; }
  button { background-color: #1976d2; color: white; border: none; padding: 10px 20px; cursor: pointer; }
  button:hover { background-color: #1565c0; }
  #result { background: #eee; padding: 10px; white-space: pre-wrap; margin-top: 10px; min-height: 80px; }
</style>
</head>
<body>

<h2>多订阅统一上传工具</h2>

<label>订阅链接（或Base64内容）：</label>
<textarea id="subInput" placeholder="输入订阅链接或直接粘贴Base64内容"></textarea>

<label>上传到 GitHub 文件名（示例 sub1.txt）：</label>
<input type="text" id="fileName" placeholder="如 sub1.txt" />

<label>筛选关键词（|分隔，默认不填即用默认关键词）：</label>
<input type="text" id="keywords" placeholder="认准|全网|客服|美女|mao|网址|网站|最新|订阅|续费|迷路|官网|流量|过期|落地|回国|本站|用户|邮箱|订阅|剩余|顶级|机场|到期|猫|赔钱|良心|liangxin|云|世界|cloud|夏日|summer" />

<button onclick="processAndUpload()">解析、筛选并上传</button>

<div id="result">结果显示区</div>

<script>
const DEFAULT_KEYWORDS = '认准|全网|客服|美女|mao|网址|网站|最新|订阅|续费|迷路|官网|流量|过期|落地|回国|本站|用户|邮箱|订阅|剩余|顶级|机场|到期|猫|赔钱|良心|liangxin|云|世界|cloud|夏日|summer';

async function processAndUpload() {
  const subInput = document.getElementById('subInput').value.trim();
  const fileName = document.getElementById('fileName').value.trim();
  let keywordsStr = document.getElementById('keywords').value.trim();

  const resultEl = document.getElementById('result');
  resultEl.textContent = '处理中，请稍候...';

  if (!subInput) {
    resultEl.textContent = '❌ 请输入订阅链接或Base64内容';
    return;
  }
  if (!fileName) {
    resultEl.textContent = '❌ 请输入上传文件名，比如 sub1.txt';
    return;
  }

  if (!keywordsStr) keywordsStr = DEFAULT_KEYWORDS;
  const keywords = keywordsStr.split('|').map(k => decodeURIComponent(k).toLowerCase());

  try {
    let base64Content = '';
    if (subInput.startsWith('http')) {
      // 订阅链接，先抓取内容
      const resp = await fetch(subInput);
      if (!resp.ok) throw new Error('订阅链接获取失败');
      base64Content = await resp.text();
    } else {
      // 直接是 Base64 内容
      base64Content = subInput;
    }

    // Base64 解码
    let decodedStr = atob(base64Content);

    // 拆分成行
    let lines = decodedStr.split('\n').map(l => l.trim()).filter(l => l.length > 0);

    // 过滤 hy2 开头节点和关键词（关键词先 URL 编码比较，参考需求）
    // hy2 协议全部屏蔽
    lines = lines.filter(line => !line.toLowerCase().startsWith('hy2://'));

    // 再筛关键词，URL 编码匹配，关键词要被排除（只要包含任意关键词对应的URL编码就剔除）
    lines = lines.filter(line => {
      let lineLower = line.toLowerCase();
      for (const kw of keywords) {
        const kwEncoded = encodeURIComponent(kw);
        if (lineLower.includes(kwEncoded)) return false;
      }
      return true;
    });

    // 结果编码成 base64
    const finalBase64 = btoa(lines.join('\n'));

    // 上传到 GitHub
    // 填写你的 GitHub 用户名、仓库名和 Token
    const githubUser = 'Kizoc';  // 你改成你自己的
    const githubRepo = 'sub';    // 仓库名
    const githubToken = '你的个人访问令牌PAT填这里';

    // 获取文件SHA（必须先获取再上传更新）
    const getShaUrl = `https://api.github.com/repos/${githubUser}/${githubRepo}/contents/${fileName}`;
    let sha = null;
    try {
      const shaResp = await fetch(getShaUrl, {
        headers: {
          'Authorization': `token ${githubToken}`
        }
      });
      if (shaResp.ok) {
        const shaData = await shaResp.json();
        sha = shaData.sha;
      }
    } catch (e) {
      // 文件不存在则不带sha上传新文件
    }

    // 准备上传内容
    const commitMsg = `更新订阅文件 ${fileName} - ${new Date().toISOString()}`;
    const uploadBody = {
      message: commitMsg,
      content: finalBase64,
      branch: 'main'
    };
    if (sha) uploadBody.sha = sha;

    const uploadUrl = `https://api.github.com/repos/${githubUser}/${githubRepo}/contents/${fileName}`;
    const uploadResp = await fetch(uploadUrl, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${githubToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(uploadBody)
    });
    if (!uploadResp.ok) {
      const errData = await uploadResp.json();
      throw new Error(errData.message || '上传失败');
    }

    resultEl.textContent = `✅ 上传成功！文件名：${fileName}\n筛选后节点数：${lines.length}`;

  } catch (err) {
    resultEl.textContent = `❌ 错误：${err.message}`;
  }
}
</script>

</body>
</html>
